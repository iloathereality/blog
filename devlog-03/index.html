<!DOCTYPE html>
<html lang="en">

<head>
    <title>Waffle Devlog 3</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>
    <meta name="author" content="Maybe Waffle">

    <meta name="theme-color" content="#EE72F1">

    
    
    <meta name="title" content="Waffle Devlog 3">
    <meta name="description" content="This week was something else! There is a lot I&#x27;ve done this week (2023-04-17‚Äî2023-04-21).">
    <meta name="image" content="https://blog.ihatereality.space/you_cant_escape_from_reality_450x450.png">

    
        <meta name="keywords" itemprop="tags" content="devlog">
    

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://blog.ihatereality.space/devlog-03/">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Waffle Devlog 3">
    <meta property="og:description" content="This week was something else! There is a lot I&#x27;ve done this week (2023-04-17‚Äî2023-04-21).">
    <meta property="og:image" content="https://blog.ihatereality.space/you_cant_escape_from_reality_450x450.png">
    <meta property="og:locale" content="en">

    
        <meta property="article:published_time" content="2023-04-21">
    

    
        
            <meta property="article:tag" content="devlog">
        
    

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary">
    <meta property="twitter:domain" content="blog.ihatereality.space">
    <meta property="twitter:url" content="https://blog.ihatereality.space/devlog-03/">
    <meta name="twitter:title" content="Waffle Devlog 3">
    <meta name="twitter:description" content="This week was something else! There is a lot I&#x27;ve done this week (2023-04-17‚Äî2023-04-21).">
    <meta name="twitter:image" content="https://blog.ihatereality.space/you_cant_escape_from_reality_450x450.png">
    <meta name="twitter:creator" content="maybewaffle">



    
    <link rel="stylesheet" href="https://blog.ihatereality.space/style.css">
    <link rel="stylesheet" href="https://blog.ihatereality.space/color/pink.css">

    <link rel="stylesheet" href="https://blog.ihatereality.space/font-hack.css">


    
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https://blog.ihatereality.space/rss.xml">
    
        <link rel="shortcut icon" type="image&#x2F;png" href="/you_cant_escape_from_reality_128x128.png">
    
    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://blog.ihatereality.space" style="text-decoration: none;">
                    <div class="logo">
                            I hate reality
                        </div>
                </a>
            </div>
        </div>

        
    <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://blog.ihatereality.space/about">about</a></li>
            
                <li><a href="https://github.com/iloathereality/blog" target="_blank" rel="noopener noreferrer">source</a></li>
            </ul>
        </nav>
    

    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://blog.ihatereality.space/devlog-03/">Waffle Devlog 3</a></h1>
    
        <div class="post-meta-inline">
            
    <span class="post-date">
            2023-04-21
        
    </span>

            
    <span class="post-read-time">
        :: 8 min read
    </span>


            <!-- TODO: rethink how tags look -->
            <br>
            
        <span class="post-tags-inline"><a class="post-tag" href="https://blog.ihatereality.space/tags/devlog/">#devlog</a></span>
    
        </div>
    


        
        <div class="post-content">
            <p>This week was something else! There is a lot I‚Äôve done this week (2023-04-17‚Äî2023-04-21). This is mostly a log for <em>myself</em> so that I remember that I did things, but you may be interested in reading it too, for whatever reason.</p>
<span id="continue-reading"></span><h1 id="assure-everyone-that-has-type-flags-is-fast">Assure everyone that <code>has_type_flags</code> is fast<a class="zola-anchor" href="#assure-everyone-that-has-type-flags-is-fast" aria-label="Anchor link for: assure-everyone-that-has-type-flags-is-fast">‚åó</a></h1>
<p>This is funny.
So I‚Äôve been working on some type-flags-adjacent changes,
in particular I‚Äôve been looking at <code>TypeVisitableExt::has_non_region_param</code>.
<code>has_non_region_param</code> calls <code>has_type_flags</code> from the same trait,
which ‚Äúvisits‚Äù <code>self</code> with <code>HasTypeFlagsVisitor</code>.</p>
<p>At the first glance this looks very suspicious ‚Äî a visitor normally recursively visits a structure,
but this is not needed here!
For example <code>Ty</code> (a type representing types in the compiler) has cached type flags,
so you don‚Äôt need to visit it to compute them again!
My first though was ‚Äúhow could such inefficient thing be used in the hot path??‚Äù,
but of course I‚Äôve just missed something.</p>
<p><code>HasTypeFlagsVisitor</code> doesn‚Äôt actually recurse all the way down!
If it visits a given type, it doesn‚Äôt go to the subtypes, it just uses the cached type flags.
So this is in fact quite efficient and totally fine.</p>
<p>It turns out that I‚Äôm not the first one to stumble upon this and be confused, so I‚Äôve made a <a href="https://github.com/rust-lang/rust/pull/110465">PR</a> that explains all of that in a comment, so that I‚Äôm hopefully the last one to be confused by that.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>number_of_people_who_has_tripped_on_this += </span><span style="color:#d08770;">1</span><span>;
</span></code></pre>
<h1 id="no-transmutes-of-genericarg-and-ty">No transmutes of <code>GenericArg</code> and <code>Ty</code><a class="zola-anchor" href="#no-transmutes-of-genericarg-and-ty" aria-label="Anchor link for: no-transmutes-of-genericarg-and-ty">‚åó</a></h1>
<p>This was my ‚Äúquest‚Äù of the week.</p>
<p>It all started from me changing how <code>Ty</code> is represented, trying to make a small optimization
(yet to be completed, hopefully those changes will see the light of day next week‚Ä¶).
Everything was good, until the compiler sigsegv‚Äôed while compiling some <code>core</code>‚Ä¶</p>
<p>At first I thought that my optimization itself was unsound or at least very broken.
Which it kind of was ‚Äî I did a little mistake, but it was not causing the sigsegv.
Then I learned from <code>@oli-obk</code> that we have some places where we transmute <code>GenericArg</code> and <code>Ty</code>,
which would be very broken for many reasons, including the fact that I changed the <code>Ty</code> representation.</p>
<p>Then I noticed in the compiler output, that it crashed inside
<code>_RNvMs7_NtCs8SrYHSYT6I_12rustc_middle2tyNtB5_2Ty13from_interned</code> (<code>rustc_middle::ty::Ty::from_interned</code>)
which was <strong>very</strong> suspicious, because <code>from_interned</code> is pretty much a trivial constructor,
which should not cause sigsegvs.
And then I noticed
<code>_RNvMse_NtNtCs8SrYHSYT6I_12rustc_middle2ty5substINtNtB7_4list4ListNtB5_10GenericArgE16try_as_type_list</code> (<code>rustc_middle::ty::subst::list::List::GenericArg::try_as_type_list</code>),
which, as you can guess from the name, transmutes between <code>GenericArg</code> and <code>Ty</code>,
causing problems because I changed <code>Ty</code>‚Äôs layout‚Ä¶</p>
 


  

  
    
  


<div class="callout">
  <img 
    class="callout-icon"
    src="/twemoji/assets/svg/1f438.svg"
    alt="üê∏"
  />
  <div class="callout-body">
    <p>As a side note: even before waffle‚Äôs changes, this was <em>technically</em> unsound,
because both <code>GenericArg</code> and <code>Ty</code> are <code>repr(Rust)</code>, which means that their layout is unstable. Yeah‚Ä¶</p>

  </div>
</div>
<p>This was originally added as a clever optimization, because, well, we can!
<code>GenericArg</code> is a tagged pointer that is basically a compressed version of <code>Ty | Region | Const</code>
(the types of possible generic arguments ‚Äî types, lifetimes and constants).
Since we‚Äôve chosen <code>Ty</code>‚Äôs tag to be <code>0b00</code>, <code>GenericArg</code> and <code>Ty</code> has the same layout!
In theory this allows us to store, hash and use types and generic args that are also types interchangeably.</p>
<p>In practice however everything is less nice:</p>
<ol>
<li>The transmutes are scattered across the code and are hard to maintain (as shown by my struggles with the sigsegv)</li>
<li>This optimization actually doesn‚Äôt noticeably change the performance and memory usage of the compiler</li>
<li>‚Ä¶ While also blocking other optimizations (as, again, shown by my problems)</li>
</ol>
<p>With all of that in mind I‚Äôve made <a href="https://github.com/rust-lang/rust/pull/110496">#110496</a> which removed the transmutes.
Later I also followed it by <a href="https://github.com/rust-lang/rust/pull/110599">#110599</a> and <a href="https://github.com/rust-lang/rust/pull/110622">#110622</a> which removed other artifacts of this optimization.</p>
<h1 id="deny-unsafe-op-in-unsafe-fn-in-rustc-data-structures"><code>deny(unsafe_op_in_unsafe_fn)</code> in <code>rustc_data_structures</code><a class="zola-anchor" href="#deny-unsafe-op-in-unsafe-fn-in-rustc-data-structures" aria-label="Anchor link for: deny-unsafe-op-in-unsafe-fn-in-rustc-data-structures">‚åó</a></h1>
<p>This is the continuation of my improvements of tagged pointers, after their cleanup it made sense to deny <code>unsafe_op_in_unsafe_fn</code> lint in the crate.</p>
<p><code>unsafe_op_in_unsafe_fn</code> lints against the following code:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">unsafe fn </span><span style="color:#8fa1b3;">dangerous</span><span>() {}
</span><span>
</span><span style="color:#b48ead;">unsafe fn </span><span style="color:#8fa1b3;">something_unsafe</span><span>() {
</span><span>    </span><span style="color:#96b5b4;">dangerous</span><span>()
</span><span>    </span><span style="color:#65737e;">//^-- this is allowed, by linted by `unsafe_op_in_unsafe_fn`
</span><span>}
</span><span>
</span><span style="color:#b48ead;">unsafe fn </span><span style="color:#8fa1b3;">something_unsafe_fixed</span><span>() {
</span><span>    </span><span style="color:#b48ead;">unsafe </span><span>{
</span><span>        </span><span style="color:#96b5b4;">dangerous</span><span>()
</span><span>    }
</span><span>    </span><span style="color:#65737e;">//^-- this is the fix for the lint
</span><span>}
</span></code></pre>
<p>The reason for this lint‚Äôs existence is that <code>unsafe fn</code> mainly conveys that it‚Äôs unsafe to call <em>that</em> function, but by default it also allows to use other <code>unsafe</code> functions inside it, without <code>unsafe</code> blocks. This might be a little foot-gun, at it places more code in <code>unsafe</code> context than necessary, potentially leading to missed safety requirements. With the lint and <code>unsafe {}</code> inside <code>unsafe</code> functions everything is more explicit and it‚Äôs less easy to make mistakes, which is very important for <code>unsafe</code> code.</p>
<h1 id="closure-suggestions-finally-merged">Closure suggestions finally merged!<a class="zola-anchor" href="#closure-suggestions-finally-merged" aria-label="Anchor link for: closure-suggestions-finally-merged">‚åó</a></h1>
<p>The pull request I‚Äôve been working on on <a href="https://blog.ihatereality.space/devlog-01/#stream">streams</a> has been finally <a href="https://github.com/rust-lang/rust/pull/110061">merged</a>, yay!</p>
<h1 id="add-impl-tag-macro-to-implement-tag-for-tagged-pointer-easily">Add <code>impl_tag!</code> macro to implement <code>Tag</code> for tagged pointer easily<a class="zola-anchor" href="#add-impl-tag-macro-to-implement-tag-for-tagged-pointer-easily" aria-label="Anchor link for: add-impl-tag-macro-to-implement-tag-for-tagged-pointer-easily">‚åó</a></h1>
<p>As the title suggests, this is a <a href="https://github.com/rust-lang/rust/pull/110615">PR</a> that continues my <a href="https://blog.ihatereality.space/devlog-02/#tagged-pointer-rewrite">work</a> on tagged pointers in rustc, by adding a macro to implement the <code>Tag</code> trait. As a reminder this is basically how <code>Tag</code> looks:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">unsafe trait </span><span>Tag {
</span><span>    </span><span style="color:#65737e;">/// The number of bits required
</span><span>    </span><span style="color:#b48ead;">const </span><span style="color:#d08770;">BITS</span><span>: </span><span style="color:#b48ead;">u32</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">into_usize</span><span>(</span><span style="color:#bf616a;">self</span><span>) -&gt; </span><span style="color:#b48ead;">usize</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">unsafe fn </span><span style="color:#8fa1b3;">from_usize</span><span>(</span><span style="color:#bf616a;">tag</span><span>: </span><span style="color:#b48ead;">usize</span><span>) -&gt; </span><span style="color:#b48ead;">Self</span><span>;
</span><span>}
</span></code></pre>
<p>Implementing it correctly is a little bit tricky, since you need to correctly handle all the <code>unsafe</code> invariants, so adding a macro seems very nice. At the moment the macro usage looks something like the following, although I‚Äôll probably remove the explicit tags later:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>impl_tag! {
</span><span>    </span><span style="color:#b48ead;">impl </span><span>Tag </span><span style="color:#b48ead;">for </span><span>Type;
</span><span>    Type::A &lt;=&gt; 0,
</span><span>    Type::B { v: </span><span style="color:#d08770;">false </span><span>} &lt;=&gt; </span><span style="color:#d08770;">1</span><span>,
</span><span>    Type::B { v: </span><span style="color:#d08770;">true </span><span>} &lt;=&gt; </span><span style="color:#d08770;">2</span><span>,
</span><span>}
</span></code></pre>
<p>I hope you agree that it‚Äôs a lot nicer than manually doing the implementation :)</p>
<p>As a side note, while working on this macro I‚Äôve discovered <a href="https://github.com/rust-lang/rust/issues/110613">#110613</a> which is annoying bug/feature of how macros and lints work, which was pretty sad. I won‚Äôt copy the issue description here, so go look at it if you want.</p>
<h1 id="other-stuff">Other stuff<a class="zola-anchor" href="#other-stuff" aria-label="Anchor link for: other-stuff">‚åó</a></h1>
<ul>
<li><a href="https://github.com/rust-lang/rust/pull/110461">rust/110461</a> ‚Äî Use <code>Item::expect_*</code> and <code>ImplItem::expect_*</code> more</li>
<li><a href="https://github.com/rust-lang/libs-team/issues/212">rust-lang/libs-team/212</a> ‚Äî <code>Option::is_none_or</code> (API change proposal)</li>
<li><a href="https://github.com/rust-lang/rust/pull/110545">rust/110545</a> ‚Äî Add <code>GenericArgKind::as_{type,const,region}</code> </li>
<li><a href="https://github.com/rust-lang/rust/pull/110539">rust/110539</a> ‚Äî Move around <code>{Idx, IndexVec, IndexSlice}</code> adjacent code</li>
<li><a href="https://github.com/rust-lang/rust/pull/110621">rust/110621</a> ‚Äî (More) consistently use ‚Äúregion‚Äù terminology in <code>rustc_middle</code></li>
<li><a href="https://github.com/rust-lang/rust/pull/110451">rust/110451</a> ‚Äî Minor changes to <code>IndexVec::ensure_contains_elem</code> &amp; related methods</li>
<li><a href="https://github.com/teloxide/teloxide/discussions/872">teloxide/discussions/872</a> ‚Äî How to add a <code>tracing::span</code> to every incoming message?
<ul>
<li>I answered this :&gt;</li>
</ul>
</li>
</ul>
<h1 id="reviews">Reviews<a class="zola-anchor" href="#reviews" aria-label="Anchor link for: reviews">‚åó</a></h1>
<ul>
<li><a href="https://github.com/rust-lang/rust/pull/110394">rust/110394</a> ‚Äî Various minor Idx-related tweaks</li>
<li><a href="https://github.com/rust-lang/rust/pull/110313">rust/110313</a> ‚Äî allow <code>repr(align = x)</code> on inherent methods</li>
<li><a href="https://github.com/rust-lang/rust/pull/106934">rust/106934</a> ‚Äî Add offset_of! macro (RFC 3308)
<ul>
<li>very happy with this one in particular, it was very nice to finally approve it!</li>
</ul>
</li>
<li><a href="https://github.com/rust-lang/rust/pull/110438">rust/110438</a> ‚Äî Allow <code>transmute</code>-ing for tuples with <code>[u8; &lt;const N: usize&gt;]</code>
<ul>
<li>this seems like a bad idea and so was basically rejected</li>
</ul>
</li>
<li><a href="https://github.com/rust-lang/rust/pull/110473">rust/110473</a> ‚Äî Assert that global cache values are stable on insertion</li>
<li><a href="https://github.com/rust-lang/rust/pull/108106">rust/108106</a> ‚Äî Improve niche placement by trying two strategies and picking the better result</li>
<li><a href="https://github.com/rust-lang/rust/pull/110548">rust/110548</a> ‚Äî Make <code>impl Debug for Span</code> not panic on not having session globals.</li>
<li><a href="https://github.com/rust-lang/rust/pull/110540">rust/110540</a> ‚Äî Fix wrong comment in rustc_hir/src/hir.rs</li>
<li><a href="https://github.com/rust-lang/rust/pull/110596">rust/110596</a> ‚Äî Rename <code>wasm32-wasi</code> to <code>wasm32-wasi-preview1</code></li>
</ul>
<h1 id="bisection">Bisection<a class="zola-anchor" href="#bisection" aria-label="Anchor link for: bisection">‚åó</a></h1>
<p>When a regression is found in the rust compiler it is helpful to run a bisection, which allows you to find which exact PR/commit/version introduced the regression. For rustc bisection is usually done via <a href="https://github.com/rust-lang/cargo-bisect-rustc"><code>cargo bisect-rustc</code></a>, which is pretty cool to look at, it runs a binary search, checking the regression and trying to find the place that changes the compilation result or script result, etc (it has multiple modes).</p>
<ul>
<li><a href="https://github.com/rust-lang/rust/issues/110551">rust/110551</a> ‚Äî Codegen regression involving <code>assume</code>/<code>unreachable_unchecked</code>
<ul>
<li>A codegen regression was found, which I helped to bisect/track (although finding the root cause and fixing was done by <code>@saethlin</code>)</li>
<li>For some reason I had a lot of problems bisecting this one, but I think I was just unlucky with my choice of upper/lower bounds on the bisection</li>
</ul>
</li>
<li><a href="https://github.com/rust-lang/rust/issues/110457">110457</a> ‚Äî Incremental recompilation MIR ICE</li>
</ul>
<h1 id="stream">Stream<a class="zola-anchor" href="#stream" aria-label="Anchor link for: stream">‚åó</a></h1>
<p>This week I did not make the programming stream, and I probably won‚Äôt make them in the near future, following my <a href="https://blog.ihatereality.space/devlog-02/#stream">concerns</a> from the previous devlog</p>
<h1 id="summary">Summary<a class="zola-anchor" href="#summary" aria-label="Anchor link for: summary">‚åó</a></h1>
<p>It feels like I did <strong>a lot</strong> this week, it feels great!!
Hopefully I won‚Äôt lose <em>all</em> that momentum next week, heh.
See you next time 0/</p>

        </div>

        
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright copyright--user"><div class="copyright"><span>¬© 2021-2024 Waffle Lapkin</span><span class="copyright-theme"><span class="copyright-theme-sep">:: </span>Theme is based on <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a></span><span class="copyright-theme-sep">:: </span><a href="/rss.xml">rss</a></div></div>
            </div>
    </footer>
    

</div>

<!-- Tracking via https://www.goatcounter.com/ -->
<script data-goatcounter="https://ihr.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>
